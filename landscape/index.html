<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>

    svg {
      cursor: grab;
    }

    svg:active {
      cursor: grabbing;
    }

    .node {
      cursor: pointer;
    }
    .node .label {
      opacity: 0;
      transition: opacity .5s;
    }
    .node:hover circle {
      fill:white;
    }
    .node:hover .label {
      opacity: 1;
    }
  </style>
</head>
<body>
  <svg id="landscape"></svg>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script type="text/javascript">
    let w = window.innerWidth-20
    let h = window.innerHeight-20
    let svg = d3.select('svg')
        .attr('width', w)
        .attr('height', h)
        .style('background-color','#e4e4e4')

    d3.json("data.json", function(err, json) {

      console.log(json.nodes)

      let nodes = json.nodes;
      // fix orientation of the viz
      nodes.forEach(function(n){ n.y*=-1 })
      // sort node so to have the upper in the background and not covering the ones in the foreground
      nodes = nodes.sort(function(a, b){return a.y - b.y})

      let margin = {
        "min_x": d3.min(nodes, function(d){ return d.x }),
        "max_x": d3.max(nodes, function(d){ return d.x }),
        "min_y": d3.min(nodes, function(d){ return d.y }),
        "max_y": d3.max(nodes, function(d){ return d.y })
      }

      let colour = d3.scaleLinear()
          .domain(d3.extent(nodes, function(d){ return d.attributes.first_publication; }))
          .range(['#FADBD8','#B03A2E'])

      let g = svg.append('g')
          .append('g')
          .attr('class','nodes')

      let node = g.selectAll('.node').data(nodes).enter()
          .append('g')
          .attr('class','node')
          .attr('transform',function(d){
            return 'scale(1,0.5773) translate('+d.x+','+d.y+')'
          })
          .attr('fill',function(d){
            return colour(d.attributes.first_publication)
          })

      // calculate the size of steps for hills
      let size_ext = d3.extent(json.nodes, function(d){return d.size})
      let min_size = size_ext[0]/5
      let step_increment = -40;

      let steps = node.selectAll('circle')
          .data(function(d){
            d.steps = []
            let i = d3.interpolateBasis(d.size,1)
            for(var j = d.size; j >= min_size; j-=min_size) {
              d.steps.push(j);
            }
            return d.steps
          })
        .enter()
          .append('circle')
          .attr('stroke','#000')
          .attr('r',function(d){ return d })
          .transition()
          .duration(1500)
          .attr('transform', function(d,i){
            i = i*step_increment
            return 'translate(0,'+i+')'
          })

      let label = node.selectAll('.label')
            .data(function(d){ return [d] })
          .enter()
            .append('text')
            .attr('class','label')
            .attr('fill','black')
            .attr('font-size','4rem')
            .attr('transform',function(d){
              return 'translate(0,'+(d.steps.length+1)*step_increment+') scale(1,'+1/0.5773+')'
            })
            .text(function(d){
              return d.attributes.title;
            })

      //add zoom capabilities
      var zoom_handler = d3.zoom()
          .on("zoom", zoom_actions);

      zoom_handler(svg);

      // svg.transition()
      //   .duration(750)
      //   .call( zoom_handler.transform, d3.zoomIdentity
      //     .translate(w/2,h/2)
      //     .scale(0.1)
      //   ); // updated for d3 v4

      //Zoom functions
      function zoom_actions(){
        // console.log(d3.event.transform)
        g.attr("transform", d3.event.transform)
      }
    })



  </script>
</body>

</html>
