<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    .node:hover circle {
      fill:red
    }
  </style>
</head>
<body>
  <svg></svg>
  <script src="https://d3js.org/d3.v4.js"></script>
  <script type="text/javascript">
    let w = window.innerWidth-20
    let h = window.innerHeight-20
    let svg = d3.select('svg')
        .attr('width', w)
        .attr('height', h)
        .style('background-color','#e4e4e4')

    d3.json("data.json", function(err, json) {
      console.log(json)

      let size_ext = d3.extent(json.nodes, function(d){return d.size})


      let min_size = size_ext[0]/4
      let step_size = size_ext[0]/min_size

      console.log(size_ext, min_size, step_size)

      let nodes = json.nodes;
      nodes.forEach(function(n){
        // n.x*=-1
        n.y*=-1
      })

      let margin = {
        "min_x": d3.min(nodes, function(d){ return d.x }),
        "max_x": d3.max(nodes, function(d){ return d.x }),
        "min_y": d3.min(nodes, function(d){ return d.y }),
        "max_y": d3.max(nodes, function(d){ return d.y })
      }

      console.log(margin)

      console.log((margin.max_x - margin.min_x)/2)

      let g = svg.append('g')
          // .style('transform','scale(1,0.5773) rotate(-45deg)')
          .append('g')
          .attr('class','nodes')

      let node = g.selectAll('.node').data(nodes).enter()
          .append('g')
          .attr('class','node')
          .attr('transform',function(d){
            return 'scale(1,0.5773) translate('+d.x+','+d.y+')'
          })

      let steps = node.selectAll('circle')
          .data(function(d){
            // console.log(d)
            d.steps = []
            let i = d3.interpolateBasis(d.size,1)
            for(var j = d.size; j >= min_size; j-=min_size) {
              // console.log(j, j/d.size)
              // console.log(i(j/d.size))
              d.steps.push(j);
            }
            // console.log(d.steps)
            return d.steps
          })
        .enter()
          .append('circle')
          .attr('fill','#fff')
          .attr('stroke','#000')
          .attr('r',function(d){ return d })
          .attr('transform', function(d,i){
            i = i*-45
            return 'translate(0,'+i+')'
          })
          // .attr('cx', function(d){ return d.x })
          // .attr('cy', function(d){ return d.y })

      let label = node.selectAll('.label')
            .data(function(d){ return [d] })
          .enter()
            .append('text')
            .attr('class','label')
            .attr('transform',function(d){
              return 'translate(0,'+(d.steps.length+2)*-45+') scale(1,'+1/0.5773+')'
            })
            .text(function(d){
              return d.attributes.title;
            })

      //add zoom capabilities
      var zoom_handler = d3.zoom()
          .on("zoom", zoom_actions);

      zoom_handler(svg);

      svg.transition()
        .duration(750)
        .call( zoom_handler.transform, d3.zoomIdentity
          .translate(w/2,h/2)
          .scale(0.1)
        ); // updated for d3 v4

      //Zoom functions
      function zoom_actions(){
        // console.log(d3.event.transform)
        g.attr("transform", d3.event.transform)
      }
    })



  </script>
</body>

</html>
